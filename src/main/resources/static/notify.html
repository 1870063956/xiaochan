<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ç®¡ç†</title>
    <!-- å¼•å…¥Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- å¼•å…¥Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- å¼•å…¥axiosç”¨äºæ¥å£è¯·æ±‚ -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <!-- å¼•å…¥è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="css/location.css">
    <link rel="stylesheet" href="css/notify.css">
</head>
<body>
<div id="app" class="container">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="/index.html" class="navbar-brand">
            ğŸ› å°èš•æ´»åŠ¨å¹³å°
        </a>
        <div class="navbar-nav">
            <a href="/index.html" class="nav-link">
                ğŸ  é¦–é¡µ
            </a>
            <a href="/location.html" class="nav-link">
                ğŸ“ åœ°å€ç®¡ç†
            </a>
            <a href="#" class="nav-link active">
                ğŸ”” é€šçŸ¥ç®¡ç†
            </a>
        </div>
    </nav>

    <!-- é€šçŸ¥é…ç½®åˆ—è¡¨åŒºåŸŸ -->
    <el-card v-if="!showDetail" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);" v-loading="loading">
        <div slot="header" class="card-header">
            <span>é€šçŸ¥é…ç½®ç®¡ç†</span>
            <el-button class="add-address-btn" @click="refreshList" :disabled="loading" style="display: flex; align-items: center; gap: 5px;">
                <i class="fa fa-refresh"></i> åˆ·æ–°åˆ—è¡¨
            </el-button>
        </div>

        <div v-if="notifyList.length === 0" class="empty-state">
            <el-empty description="æš‚æ— é€šçŸ¥é…ç½®">
                <el-button class="add-address-btn" @click="refreshList" slot="bottom">
                    <i class="fa fa-refresh"></i> åˆ·æ–°åˆ—è¡¨
                </el-button>
            </el-empty>
        </div>

        <div v-else class="notify-grid mt-4">
            <el-card
                    v-for="(config, index) in notifyList"
                    :key="config.id"
                    class="address-card"
                    :style="{animationDelay: (index * 0.1) + 's'}"
            >
                <div>
                    <div class="address-header">
                        <div class="address-name">
                            <i class="fa fa-bell"></i> {{ config.location?.name || 'æœªçŸ¥åœ°å€' }}
                        </div>
                        <el-tag 
                            :type="getStatusType(config.status)" 
                            size="small"
                            style="margin-left: auto;"
                        >
                            {{ getStatusText(config.status) }}
                        </el-tag>
                    </div>

                    <div class="notify-info">
                        <p class="info-item">
                            <i class="fa fa-store"></i>
                            <span>é—¨åº—ï¼š{{ config.storeInfo?.name || 'æœªçŸ¥é—¨åº—' }}</span>
                        </p>
                        <p class="info-item">
                            <i class="fa fa-tag"></i>
                            <span>ç±»å‹ï¼š{{ getTypeText(config.type) }}</span>
                        </p>
                        <p class="info-item">
                            <i class="fa fa-refresh"></i>
                            <span>åªæé†’ä¸€æ¬¡ï¼š{{ config.onlyOne ? 'æ˜¯' : 'å¦' }}</span>
                        </p>
                        <p class="info-item">
                            <i class="fa fa-calendar"></i>
                            <span>æœ‰æ•ˆå¤©æ•°ï¼š{{ config.expireDay || 'æ— é™åˆ¶' }}</span>
                        </p>
                        <p class="info-item">
                            <i class="fa fa-bell-o"></i>
                            <span>é€šçŸ¥æ¬¡æ•°ï¼š{{ config.notifyCount || 0 }}</span>
                        </p>
                    </div>

                    <div class="operation-buttons">
                        <el-button
                                size="small"
                                class="edit-btn"
                                @click="viewDetail(config)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                        </el-button>
                        <el-button
                                size="small"
                                class="delete-btn"
                                @click="deleteNotifyConfig(config.id, index)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-trash"></i> åˆ é™¤
                        </el-button>
                    </div>
                </div>
            </el-card>
        </div>
    </el-card>

    <!-- è¯¦æƒ…å±•ç¤ºåŒºåŸŸ -->
    <el-card v-if="showDetail" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);">
        <div slot="header" class="card-header">
            <span>é€šçŸ¥é…ç½®è¯¦æƒ…</span>
            <el-button type="text" @click="backToList" style="display: flex; align-items: center; gap: 3px;">
                <i class="fa fa-arrow-left"></i> è¿”å›åˆ—è¡¨
            </el-button>
        </div>

        <div v-if="currentDetail" class="detail-content">
            <div class="detail-section">
                <h3><i class="fa fa-bell"></i> åŸºæœ¬ä¿¡æ¯</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>é…ç½®IDï¼š</label>
                        <span>{{ currentDetail.id }}</span>
                    </div>
                    <div class="detail-item">
                        <label>ç±»å‹ï¼š</label>
                        <span>{{ getTypeText(currentDetail.type) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>çŠ¶æ€ï¼š</label>
                        <el-tag :type="getStatusType(currentDetail.status)">
                            {{ getStatusText(currentDetail.status) }}
                        </el-tag>
                    </div>
                    <div class="detail-item">
                        <label>åªæé†’ä¸€æ¬¡ï¼š</label>
                        <span>{{ currentDetail.onlyOne ? 'æ˜¯' : 'å¦' }}</span>
                    </div>
                    <div class="detail-item">
                        <label>æœ‰æ•ˆå¤©æ•°ï¼š</label>
                        <span>{{ currentDetail.expireDay || 'æ— é™åˆ¶' }}</span>
                    </div>
                    <div class="detail-item">
                        <label>é€šçŸ¥æ¬¡æ•°ï¼š</label>
                        <span>{{ currentDetail.notifyCount || 0 }}</span>
                    </div>
                    <div class="detail-item">
                        <label>åˆ›å»ºæ—¶é—´ï¼š</label>
                        <span>{{ formatDate(currentDetail.createTime) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>ä¸Šæ¬¡é€šçŸ¥æ—¶é—´ï¼š</label>
                        <span>{{ formatDate(currentDetail.lastNotifyTime) || 'æš‚æ— ' }}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section" v-if="currentDetail.location">
                <h3><i class="fa fa-map-marker"></i> ä½ç½®ä¿¡æ¯</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>åœ°å€åç§°ï¼š</label>
                        <span>{{ currentDetail.location.name }}</span>
                    </div>
                    <div class="detail-item">
                        <label>æ¨é€SPTï¼š</label>
                        <span>{{ currentDetail.location.spt || 'æ— ' }}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section" v-if="currentDetail.storeInfo">
                <h3><i class="fa fa-store"></i> é—¨åº—ä¿¡æ¯</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>é—¨åº—åç§°ï¼š</label>
                        <span>{{ currentDetail.storeInfo.name }}</span>
                    </div>
                    <div class="detail-item">
                        <label>é—¨åº—IDï¼š</label>
                        <span>{{ currentDetail.storeInfo.storeId }}</span>
                    </div>
                    <div class="detail-item">
                        <label>å¹³å°ç±»å‹ï¼š</label>
                        <span>{{ getPlatformNameById(currentDetail.storeInfo.type) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>æ»¡è¿”é‡‘é¢ï¼š</label>
                        <span>æ»¡{{ currentDetail.storeInfo.price }}è¿”{{ currentDetail.storeInfo.rebatePrice }}</span>
                    </div>
                    <div class="detail-item">
                        <label>å¥½è¯„æ¡ä»¶ï¼š</label>
                        <span>{{ getRebateConditionText(currentDetail.storeInfo.rebateCondition) }}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section" v-if="currentDetail.remark">
                <h3><i class="fa fa-comment"></i> å¤‡æ³¨ä¿¡æ¯</h3>
                <div class="remark-content">
                    {{ currentDetail.remark }}
                </div>
            </div>
        </div>
    </el-card>
</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                // é€šçŸ¥é…ç½®åˆ—è¡¨
                notifyList: [],

                // çŠ¶æ€æ§åˆ¶
                loading: false,
                showDetail: false,
                currentDetail: null
            };
        },
        mounted() {
            this.loadNotifyList();
        },
        methods: {
            // åŠ è½½é€šçŸ¥é…ç½®åˆ—è¡¨
            async loadNotifyList() {
                this.loading = true;
                try {
                    const response = await axios.get('/api/notify/config/list');
                    if (response.data.success) {
                        this.notifyList = response.data.data || [];
                    } else {
                        this.$message.error(response.data.msg || 'è·å–é€šçŸ¥é…ç½®åˆ—è¡¨å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è·å–é€šçŸ¥é…ç½®åˆ—è¡¨å¤±è´¥:', error);
                    this.$message.error('è·å–é€šçŸ¥é…ç½®åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                } finally {
                    this.loading = false;
                }
            },

            // åˆ·æ–°åˆ—è¡¨
            refreshList() {
                this.loadNotifyList();
            },

            // æŸ¥çœ‹è¯¦æƒ…
            viewDetail(config) {
                this.currentDetail = config;
                this.showDetail = true;
            },

            // è¿”å›åˆ—è¡¨
            backToList() {
                this.showDetail = false;
                this.currentDetail = null;
            },

            // åˆ é™¤é€šçŸ¥é…ç½®
            deleteNotifyConfig(configId, index) {
                this.$confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé€šçŸ¥é…ç½®å—ï¼Ÿ', 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(async () => {
                    this.loading = true;
                    try {
                        const response = await axios.delete(`/api/notify/config/${configId}`);
                        if (response.data.success) {
                            this.$message.success('é€šçŸ¥é…ç½®åˆ é™¤æˆåŠŸ');
                            // é‡æ–°åŠ è½½åˆ—è¡¨
                            await this.loadNotifyList();
                        } else {
                            this.$message.error(response.data.msg || 'é€šçŸ¥é…ç½®åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤é€šçŸ¥é…ç½®å¤±è´¥:', error);
                        this.$message.error('åˆ é™¤é€šçŸ¥é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        this.loading = false;
                    }
                }).catch(() => {
                    this.$message.info('å·²å–æ¶ˆåˆ é™¤');
                });
            },

            // è·å–çŠ¶æ€ç±»å‹ï¼ˆç”¨äºæ ‡ç­¾é¢œè‰²ï¼‰
            getStatusType(status) {
                switch (status) {
                    case 0: return 'info';    // åœç”¨
                    case 1: return 'success'; // æ­£å¸¸
                    case 2: return 'warning'; // å·²ç»“æŸ
                    default: return '';
                }
            },

            // è·å–çŠ¶æ€æ–‡æœ¬
            getStatusText(status) {
                switch (status) {
                    case 0: return 'åœç”¨';
                    case 1: return 'æ­£å¸¸';
                    case 2: return 'å·²ç»“æŸ';
                    default: return 'æœªçŸ¥';
                }
            },

            // è·å–ç±»å‹æ–‡æœ¬
            getTypeText(type) {
                switch (type) {
                    case 1: return 'æŒ‡å®šé—¨åº—æ´»åŠ¨æé†’';
                    case 2: return 'è‡ªå®šä¹‰è§„åˆ™æé†’';
                    default: return 'æœªçŸ¥ç±»å‹';
                }
            },

            // æ ¼å¼åŒ–æ—¥æœŸ
            formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleString('zh-CN');
            },

            // æ ¹æ®å¹³å°ç±»å‹IDè·å–å¹³å°åç§°
            getPlatformNameById(type) {
                switch (type) {
                    case 1: return 'ç¾å›¢';
                    case 2: return 'é¥¿äº†ä¹ˆ';
                    case 3: return 'äº¬ä¸œ';
                    default: return 'æœªçŸ¥å¹³å°';
                }
            },

            // æ ¼å¼åŒ–è·ç¦»
            formatDistance(distance) {
                if (!distance) return 'æœªçŸ¥';
                if (distance < 1000) {
                    return distance + 'm';
                } else {
                    return (distance / 1000).toFixed(1) + 'km';
                }
            },

            // è·å–å¥½è¯„æ¡ä»¶æ–‡æœ¬
            getRebateConditionText(condition) {
                switch (condition) {
                    case 99: return 'æ— éœ€è¯„ä»·';
                    case 2: return 'å›¾æ–‡è¯„ä»·';
                    default: return 'æœªçŸ¥æ¡ä»¶';
                }
            }
        }
    });
</script>
</body>
</html>
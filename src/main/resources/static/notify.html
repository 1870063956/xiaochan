<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šçŸ¥ç®¡ç†</title>
    <!-- å¼•å…¥Vue -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <!-- Element UI JS -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <!-- å¼•å…¥Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- å¼•å…¥Font Awesomeå›¾æ ‡ -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <!-- å¼•å…¥è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="css/location.css">
    <link rel="stylesheet" href="css/notify.css">
</head>
<body>
<div id="app" class="container">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="/index.html" class="navbar-brand">
            ğŸ› å°èš•æ´»åŠ¨å¹³å°
        </a>
        <div class="navbar-nav">
            <a href="/index.html" class="nav-link">
                ğŸ  é¦–é¡µ
            </a>
            <a href="/location.html" class="nav-link">
                ğŸ“ åœ°å€ç®¡ç†
            </a>
            <a href="#" class="nav-link active">
                ğŸ”” é€šçŸ¥ç®¡ç†
            </a>
        </div>
    </nav>

    <!-- é€šçŸ¥é…ç½®åˆ—è¡¨åŒºåŸŸ -->
    <el-card v-if="!showDetail" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);" v-loading="loading">
        <div slot="header" class="card-header">
            <span>é€šçŸ¥é…ç½®ç®¡ç†</span>
            <div style="display: flex; gap: 10px;">
                <el-button class="add-address-btn" @click="showAddDialog" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-plus"></i> æ–°å¢é€šçŸ¥
                </el-button>
                <el-button class="add-address-btn" @click="refreshList" :disabled="loading" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-refresh"></i> åˆ·æ–°åˆ—è¡¨
                </el-button>
            </div>
        </div>

        <div v-if="notifyList.length === 0" class="empty-state">
            <el-empty description="æš‚æ— é€šçŸ¥é…ç½®">
                <el-button class="add-address-btn" @click="refreshList" slot="bottom">
                    <i class="fa fa-refresh"></i> åˆ·æ–°åˆ—è¡¨
                </el-button>
            </el-empty>
        </div>

        <div v-else class="notify-grid mt-4">
            <el-card
                    v-for="(config, index) in notifyList"
                    :key="config.id"
                    class="address-card"
                    :style="{animationDelay: (index * 0.1) + 's'}"
            >
                <div>
                    <div class="address-header">
                        <div class="address-name">
                            <i class="fa fa-bell"></i> {{ config.location?.name || 'æœªçŸ¥åœ°å€' }}
                        </div>
                        <el-tag 
                            :type="getStatusType(config.status)" 
                            size="small"
                            style="margin-left: auto;"
                        >
                            {{ getStatusText(config.status) }}
                        </el-tag>
                    </div>

                    <div class="notify-info">
                        <p class="info-item">
                            <i class="fa fa-store"></i>
                            <span>æè¿°ï¼š{{ config.desc }}</span>
                        </p>
                        <p class="info-item">
                            <i class="fa fa-tag"></i>
                            <span>ç±»å‹ï¼š{{ getTypeText(config.type) }}</span>
                        </p>
                        <p class="info-item">
                            <i class="fa fa-calendar"></i>
                            <span>æœ‰æ•ˆå¤©æ•°ï¼š{{ config.expireDay || 'æ— é™åˆ¶' }}</span>
                        </p>
                        <p class="info-item">
                            <i class="fa fa-bell-o"></i>
                            <span>é€šçŸ¥æ¬¡æ•°ï¼š{{ config.notifyCount || 0 }}</span>
                        </p>
                    </div>

                    <div class="operation-buttons">
                        <el-button
                                size="small"
                                class="edit-btn"
                                @click="viewDetail(config)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-eye"></i> æŸ¥çœ‹è¯¦æƒ…
                        </el-button>
                        <el-button
                                size="small"
                                class="delete-btn"
                                @click="deleteNotifyConfig(config.id, index)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-trash"></i> åˆ é™¤
                        </el-button>
                    </div>
                </div>
            </el-card>
        </div>
    </el-card>

    <!-- è¯¦æƒ…å±•ç¤ºåŒºåŸŸ -->
    <el-card v-if="showDetail" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);">
        <div slot="header" class="card-header">
            <span>é€šçŸ¥é…ç½®è¯¦æƒ…</span>
            <el-button type="text" @click="backToList" style="display: flex; align-items: center; gap: 3px;">
                <i class="fa fa-arrow-left"></i> è¿”å›åˆ—è¡¨
            </el-button>
        </div>

        <div v-if="currentDetail" class="detail-content">
            <div class="detail-section">
                <h3><i class="fa fa-bell"></i> åŸºæœ¬ä¿¡æ¯</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>é…ç½®IDï¼š</label>
                        <span>{{ currentDetail.id }}</span>
                    </div>
                     <div class="detail-item">
                        <label>æè¿°ï¼š</label>
                        <span>{{ currentDetail.desc }}</span>
                    </div>
                    <div class="detail-item">
                        <label>ç±»å‹ï¼š</label>
                        <span>{{ getTypeText(currentDetail.type) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>çŠ¶æ€ï¼š</label>
                        <el-tag :type="getStatusType(currentDetail.status)">
                            {{ getStatusText(currentDetail.status) }}
                        </el-tag>
                    </div>
                    <div class="detail-item">
                        <label>é€šçŸ¥æ¬¡æ•°ï¼š</label>
                        <span>{{ currentDetail.notifyCount || 0 }}</span>
                    </div>
                    <div class="detail-item">
                        <label>åˆ›å»ºæ—¶é—´ï¼š</label>
                        <span>{{ formatDate(currentDetail.createTime) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>ä¸Šæ¬¡é€šçŸ¥æ—¶é—´ï¼š</label>
                        <span>{{ formatDate(currentDetail.lastNotifyTime) || 'æš‚æ— ' }}</span>
                    </div>
                     <div class="detail-item">
                        <label>å¤‡æ³¨ï¼š</label>
                        <span>{{ currentDetail.remark }}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section" v-if="currentDetail.location">
                <h3><i class="fa fa-map-marker"></i> ä½ç½®ä¿¡æ¯</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>åœ°å€åç§°ï¼š</label>
                        <span>{{ currentDetail.location.name }}</span>
                    </div>
                    <div class="detail-item">
                        <label>æ¨é€SPTï¼š</label>
                        <span>{{ currentDetail.location.spt || 'æ— ' }}</span>
                    </div>
                </div>
            </div>

            <div class="detail-section" v-if="currentDetail.type === 1 && currentDetail.storeExtNotifyConfig.storeInfo">
                <h3><i class="fa fa-store"></i> é—¨åº—é…ç½®</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>é—¨åº—åç§°ï¼š</label>
                        <span>{{ currentDetail.storeExtNotifyConfig.storeInfo.name }}</span>
                    </div>
                    <div class="detail-item">
                        <label>é—¨åº—IDï¼š</label>
                        <span>{{ currentDetail.storeExtNotifyConfig.storeInfo.storeId }}</span>
                    </div>
                    <div class="detail-item">
                        <label>é—¨åº—å¹³å°ï¼š</label>
                        <span>{{ getPlatformNameById(currentDetail.storeExtNotifyConfig.storeInfo.type) }}</span>
                    </div>
                    <div class="detail-item">
                        <label>æ»¡è¿”é‡‘é¢ï¼š</label>
                        <span>æ»¡{{ currentDetail.storeExtNotifyConfig.storeInfo.price }}è¿”{{ currentDetail.storeExtNotifyConfig.storeInfo.rebatePrice }}</span>
                    </div>
                    <div class="detail-item">
                        <label>å¥½è¯„æ¡ä»¶ï¼š</label>
                        <span>{{ getRebateConditionText(currentDetail.storeExtNotifyConfig.storeInfo.rebateCondition) }}</span>
                    </div>
                     <div class="detail-item">
                        <label>æ˜¯å¦ä»…æé†’ä¸€æ¬¡ï¼š</label>
                        <span>{{ currentDetail.storeExtNotifyConfig.onlyOne ? 'æ˜¯' : 'å¦' }}</span>
                    </div>
                    <div class="detail-item">
                        <label>æœ‰æ•ˆå¤©æ•°ï¼š</label>
                        <span>{{ currentDetail.expireDay || 'æ— é™åˆ¶' }}</span>
                    </div>
                </div>
            </div>

            <!-- æ·»åŠ typeä¸º2æ—¶çš„é¢å¤–ä¿¡æ¯å±•ç¤º -->
            <div class="detail-section" v-if="currentDetail.type === 2 && currentDetail.maxDiffPriceExtNotifyConfig">
                <h3><i class="fa fa-money"></i> é‡‘é¢å·®é…ç½®</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>æœ€å¤§é‡‘é¢å·®ï¼š</label>
                        <span>{{ currentDetail.maxDiffPriceExtNotifyConfig.maxDiffPrice }}</span>
                    </div>
                    <div class="detail-item">
                        <label>é—´éš”å¤©æ•°ï¼š</label>
                        <span>{{ currentDetail.maxDiffPriceExtNotifyConfig.idleDay }}</span>
                    </div>
                </div>
            </div>
        </div>
    </el-card>
    
    <!-- æ–°å¢é€šçŸ¥é…ç½®å¯¹è¯æ¡† -->
    <el-dialog
        title="æ–°å¢é€šçŸ¥é…ç½®"
        :visible.sync="addDialogVisible"
        width="500px"
        @close="resetAddForm"
        :modal-append-to-body="true"
        :append-to-body="true"
        :close-on-click-modal="false"
        style="margin-top: 5vh;">
        <el-form :model="addForm" :rules="addRules" ref="addForm" label-width="100px">
            <el-form-item label="ç±»å‹" prop="type">
                <el-select v-model="addForm.type" placeholder="è¯·é€‰æ‹©ç±»å‹" style="width: 100%;">
                    <el-option label="é‡‘é¢å·®" :value="2"></el-option>
                </el-select>
            </el-form-item>

            <el-form-item label="ä½ç½®" prop="location">
                <el-select v-model="addForm.location" placeholder="è¯·é€‰æ‹©ä½ç½®" style="width: 100%;">
                    <el-option
                        v-for="loc in locationList"
                        :key="loc.id"
                        :label="loc.name"
                        :value="loc">
                    </el-option>
                </el-select>
            </el-form-item>

            <!-- typeä¸º2æ—¶çš„é…ç½®é¡¹ -->
            <template v-if="addForm.type === 2">
                <el-row :gutter="20">
                    <el-col :span="12">
                        <el-form-item label="æœ€å¤§é‡‘é¢å·®" prop="maxDiffPriceExtNotifyConfig.maxDiffPrice">
                            <el-input-number
                                v-model="addForm.maxDiffPriceExtNotifyConfig.maxDiffPrice"
                                :min="1"
                                controls-position="right"
                                style="width: 100%;">
                            </el-input-number>
                        </el-form-item>
                    </el-col>
                    <el-col :span="12">
                        <el-form-item label="é—´éš”å¤©æ•°" prop="maxDiffPriceExtNotifyConfig.idleDay">
                            <el-input-number
                                v-model="addForm.maxDiffPriceExtNotifyConfig.idleDay"
                                :min="1"
                                controls-position="right"
                                style="width: 100%;">
                            </el-input-number>
                        </el-form-item>
                    </el-col>
                </el-row>
            </template>
        </el-form>

        <div slot="footer" class="dialog-footer">
            <el-button @click="addDialogVisible = false">å– æ¶ˆ</el-button>
            <el-button type="primary" @click="submitAddForm" :loading="submitLoading">ç¡® å®š</el-button>
        </div>
    </el-dialog>
</div>


<script>
    new Vue({
        el: '#app',
        data() {
            return {
                // é€šçŸ¥é…ç½®åˆ—è¡¨
                notifyList: [],

                // çŠ¶æ€æ§åˆ¶
                loading: false,
                showDetail: false,
                currentDetail: null,
                
                // æ–°å¢å¯¹è¯æ¡†ç›¸å…³
                addDialogVisible: false,
                submitLoading: false,
                locationList: [],
                addForm: {
                    type: 2,
                    location: null,
                    maxDiffPriceExtNotifyConfig: {
                        maxDiffPrice: 1,
                        idleDay: 1
                    }
                },
                addRules: {
                    type: [
                        { required: true, message: 'è¯·é€‰æ‹©ç±»å‹', trigger: 'change' }
                    ],
                    location: [
                        { required: true, message: 'è¯·é€‰æ‹©ä½ç½®', trigger: 'change' }
                    ],
                    'maxDiffPriceExtNotifyConfig.maxDiffPrice': [
                        { required: true, message: 'è¯·è¾“å…¥æœ€å¤§é‡‘é¢å·®', trigger: 'blur' }
                    ],
                    'maxDiffPriceExtNotifyConfig.idleDay': [
                        { required: true, message: 'è¯·è¾“å…¥é—´éš”å¤©æ•°', trigger: 'blur' }
                    ]
                }
            };
        },
        mounted() {
            this.loadNotifyList();
            this.loadLocations();
        },
        methods: {
            // æ˜¾ç¤ºæ–°å¢å¯¹è¯æ¡†
            showAddDialog() {
                console.log('æ˜¾ç¤ºæ–°å¢å¯¹è¯æ¡†');
                this.addDialogVisible = true;
            },
            
            // é‡ç½®æ–°å¢è¡¨å•
            resetAddForm() {
                this.$refs.addForm.resetFields();
                this.addForm = {
                    type: 2,
                    location: null,
                    maxDiffPriceExtNotifyConfig: {
                        maxDiffPrice: 1,
                        idleDay: 1
                    }
                };
            },
            
            // åŠ è½½ä½ç½®åˆ—è¡¨
            async loadLocations() {
                try {
                    const response = await axios.get('/api/location');
                    console.log('è·å–ä½ç½®åˆ—è¡¨å“åº”:', response);
                    if (response.data.success) {
                        this.locationList = response.data.data || [];
                    } else {
                        this.$message.error(response.data.msg || 'è·å–ä½ç½®åˆ—è¡¨å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è·å–ä½ç½®åˆ—è¡¨å¤±è´¥:', error);
                    this.$message.error('è·å–ä½ç½®åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
            },
            
            // æäº¤æ–°å¢è¡¨å•
            submitAddForm() {
                this.$refs.addForm.validate(async (valid) => {
                    if (valid) {
                        this.submitLoading = true;
                        try {
                            // æ„é€ è¯·æ±‚å‚æ•°
                            const requestData = {
                                type: this.addForm.type,
                                location: this.addForm.location
                            };
                            
                            // æ ¹æ®typeæ·»åŠ ç›¸åº”çš„é…ç½®
                            if (this.addForm.type === 2) {
                                requestData.maxDiffPriceExtNotifyConfig = this.addForm.maxDiffPriceExtNotifyConfig;
                                // typeä¸º2æ—¶ï¼Œä¸ä¼ storeExtConfig
                            }
                            
                            console.log('æäº¤é€šçŸ¥é…ç½®è¯·æ±‚æ•°æ®:', requestData);
                            const response = await axios.post('/api/notify/config', requestData);
                            console.log('æäº¤é€šçŸ¥é…ç½®å“åº”:', response);
                            
                            if (response.data.success) {
                                this.$message.success('é€šçŸ¥é…ç½®ä¿å­˜æˆåŠŸ');
                                this.addDialogVisible = false;
                                // é‡æ–°åŠ è½½åˆ—è¡¨
                                await this.loadNotifyList();
                            } else {
                                this.$message.error(response.data.msg || 'é€šçŸ¥é…ç½®ä¿å­˜å¤±è´¥');
                            }
                        } catch (error) {
                            console.error('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥:', error);
                            this.$message.error('ä¿å­˜é€šçŸ¥é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                        } finally {
                            this.submitLoading = false;
                        }
                    }
                });
            },
            
            // åŠ è½½é€šçŸ¥é…ç½®åˆ—è¡¨
            async loadNotifyList() {
                this.loading = true;
                try {
                    const response = await axios.get('/api/notify/config/list');
                    console.log('è·å–é€šçŸ¥é…ç½®åˆ—è¡¨å“åº”:', response);
                    if (response.data.success) {
                        this.notifyList = response.data.data || [];
                    } else {
                        this.$message.error(response.data.msg || 'è·å–é€šçŸ¥é…ç½®åˆ—è¡¨å¤±è´¥');
                    }
                } catch (error) {
                    console.error('è·å–é€šçŸ¥é…ç½®åˆ—è¡¨å¤±è´¥:', error);
                    this.$message.error('è·å–é€šçŸ¥é…ç½®åˆ—è¡¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                } finally {
                    this.loading = false;
                }
            },

            // åˆ·æ–°åˆ—è¡¨
            refreshList() {
                this.loadNotifyList();
            },

            // æŸ¥çœ‹è¯¦æƒ…
            viewDetail(config) {
                this.currentDetail = config;
                this.showDetail = true;
            },

            // è¿”å›åˆ—è¡¨
            backToList() {
                this.showDetail = false;
                this.currentDetail = null;
            },

            // åˆ é™¤é€šçŸ¥é…ç½®
            deleteNotifyConfig(configId, index) {
                this.$confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé€šçŸ¥é…ç½®å—ï¼Ÿ', 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(async () => {
                    this.loading = true;
                    try {
                        const response = await axios.delete(`/api/notify/config/${configId}`);
                        if (response.data.success) {
                            this.$message.success('é€šçŸ¥é…ç½®åˆ é™¤æˆåŠŸ');
                            // é‡æ–°åŠ è½½åˆ—è¡¨
                            await this.loadNotifyList();
                        } else {
                            this.$message.error(response.data.msg || 'é€šçŸ¥é…ç½®åˆ é™¤å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åˆ é™¤é€šçŸ¥é…ç½®å¤±è´¥:', error);
                        this.$message.error('åˆ é™¤é€šçŸ¥é…ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                    } finally {
                        this.loading = false;
                    }
                }).catch(() => {
                    this.$message.info('å·²å–æ¶ˆåˆ é™¤');
                });
            },

            // è·å–çŠ¶æ€ç±»å‹ï¼ˆç”¨äºæ ‡ç­¾é¢œè‰²ï¼‰
            getStatusType(status) {
                switch (status) {
                    case 0: return 'info';    // åœç”¨
                    case 1: return 'success'; // æ­£å¸¸
                    case 2: return 'warning'; // å·²ç»“æŸ
                    default: return '';
                }
            },

            // è·å–çŠ¶æ€æ–‡æœ¬
            getStatusText(status) {
                switch (status) {
                    case 0: return 'åœç”¨';
                    case 1: return 'æ­£å¸¸';
                    case 2: return 'å·²ç»“æŸ';
                    default: return 'æœªçŸ¥';
                }
            },

            // è·å–ç±»å‹æ–‡æœ¬
            getTypeText(type) {
                switch (type) {
                    case 1: return 'æŒ‡å®šé—¨åº—';
                    case 2: return 'é‡‘é¢å·®';
                    default: return 'æœªçŸ¥ç±»å‹';
                }
            },

            // æ ¼å¼åŒ–æ—¥æœŸ
            formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleString('zh-CN');
            },

            // æ ¹æ®å¹³å°ç±»å‹IDè·å–å¹³å°åç§°
            getPlatformNameById(type) {
                switch (type) {
                    case 1: return 'ç¾å›¢';
                    case 2: return 'é¥¿äº†ä¹ˆ';
                    case 3: return 'äº¬ä¸œ';
                    default: return 'æœªçŸ¥å¹³å°';
                }
            },

            // æ ¼å¼åŒ–è·ç¦»
            formatDistance(distance) {
                if (!distance) return 'æœªçŸ¥';
                if (distance < 1000) {
                    return distance + 'm';
                } else {
                    return (distance / 1000).toFixed(1) + 'km';
                }
            },

            // è·å–å¥½è¯„æ¡ä»¶æ–‡æœ¬
            getRebateConditionText(condition) {
                switch (condition) {
                    case 99: return 'æ— éœ€è¯„ä»·';
                    case 2: return 'å›¾æ–‡è¯„ä»·';
                    default: return 'æœªçŸ¥æ¡ä»¶';
                }
            }
        }
    });
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地址管理</title>
    <!-- 引入Vue -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <!-- 引入Element UI -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- 引入axios用于接口请求 -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- 引入Font Awesome图标 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        /* 基础样式 */
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* 地址卡片样式 */
        .address-card {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            border-radius: 12px;
            border: none;
            overflow: hidden;
            position: relative;
        }
        .address-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08), 0 6px 6px rgba(0, 0, 0, 0.05);
            transform: translateY(-4px);
        }
        .address-card .el-card__body {
            padding: 20px;
        }
        .address-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        .address-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .address-name i {
            color: #36b37e;
            font-size: 14px;
        }
        .address-main {
            color: #666;
            line-height: 1.6;
            margin-bottom: 10px;
            padding-left: 22px;
            position: relative;
        }
        .address-main:before {
            content: "\f041";
            font-family: "FontAwesome";
            position: absolute;
            left: 0;
            top: 2px;
            color: #888;
            font-size: 14px;
        }
        .spt-info {
            font-size: 13px;
            color: #888;
            padding-left: 22px;
            position: relative;
            margin-bottom: 15px;
        }
        .spt-info:before {
            content: "\f080";
            font-family: "FontAwesome";
            position: absolute;
            left: 0;
            top: 2px;
            color: #888;
            font-size: 12px;
        }

        /* 操作按钮样式 - 优化后 */
        .operation-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            align-items: center;
            margin-top: 15px;
        }
        .edit-btn {
            background-color: #f0f7ff !important;
            color: #1890ff !important;
            border-color: #bbd7ff !important;
        }
        .edit-btn:hover {
            background-color: #e6f7ff !important;
            transform: translateY(-2px);
        }
        .delete-btn {
            background-color: #fff2f0 !important;
            color: #ff4d4f !important;
            border-color: #ffccc7 !important;
        }
        .delete-btn:hover {
            background-color: #fff1f0 !important;
            transform: translateY(-2px);
        }

        /* 标签样式优化 */
        .el-tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        .el-tag--success {
            background-color: #f0f9eb;
            color: #52c41a;
            border-color: #b7eb8f;
        }
        .el-tag--info {
            background-color: #f0f2f5;
            color: #1890ff;
            border-color: #91d5ff;
        }

        /* 表单样式优化 */
        .el-form {
            background-color: #fff;
            padding: 15px;
            border-radius: 8px;
        }
        .el-form-item {
            margin-bottom: 20px;
        }
        .el-form-item__label {
            font-weight: 500;
            color: #555;
        }
        .el-input__inner, .el-select__inner, .el-cascader__input-inner, .el-autocomplete__input {
            border-radius: 6px;
            padding: 10px 15px;
            border-color: #e0e0e0;
            transition: all 0.3s ease;
        }
        .el-input__inner:focus, .el-select__inner:focus, .el-cascader__input-inner:focus, .el-autocomplete__input:focus {
            border-color: #36b37e;
            box-shadow: 0 0 0 2px rgba(54, 179, 126, 0.2);
        }

        /* 按钮样式优化 */
        .el-button {
            border-radius: 6px;
            padding: 8px 16px;
            transition: all 0.2s ease;
        }
        /* 新增地址按钮样式 */
        .add-address-btn {
            background-color: #36b37e !important;
            border-color: #36b37e !important;
            color: #ffffff !important;
        }
        .add-address-btn:hover {
            background-color: #2d9d6b !important;
            border-color: #2d9d6b !important;
            transform: translateY(-2px);
        }
        .el-button--primary {
            background-color: #36b37e;
            border-color: #36b37e;
            color: #fff;
        }
        .el-button--primary:hover {
            background-color: #2d9d6b;
            border-color: #2d9d6b;
            transform: translateY(-2px);
        }

        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            background-color: #fff;
            border-radius: 8px;
            margin-top: 20px;
        }
        .empty-state .el-empty__image {
            margin-bottom: 20px;
        }
        .empty-state .el-empty__description {
            color: #888;
            margin-bottom: 20px;
        }

        /* 已选地址样式 */
        .selected-address {
            margin-top: 10px;
            padding: 12px 15px;
            background-color: #f5f7fa;
            border-radius: 6px;
            border-left: 3px solid #36b37e;
            transition: all 0.3s ease;
        }
        .selected-address:hover {
            background-color: #f0f9eb;
        }
        .selected-address .title {
            font-weight: 500;
            margin-bottom: 5px;
            color: #333;
        }
        .selected-address .detail {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
        }

        /* 页面头部样式 */
        .el-page-header {
            margin-bottom: 20px;
            padding: 15px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .el-page-header__content {
            font-size: 20px;
            font-weight: 600;
            color: #333;
        }
        .el-page-header__left .el-icon-back {
            font-size: 18px;
            color: #666;
            transition: all 0.2s ease;
        }
        .el-page-header__left .el-icon-back:hover {
            color: #36b37e;
            transform: translateX(-3px);
        }

        /* 卡片头部样式 */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .card-header span {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        /* 表单按钮区域样式 */
        .form-actions {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        /* 推送开关样式 */
        .push-switch-container {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
        }

        /* 响应式调整 */
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .address-card .el-card__body {
                padding: 15px;
            }
            .operation-buttons {
                flex-direction: column;
                gap: 5px;
            }
            .operation-buttons .el-button {
                width: 100%;
            }
            .card-header {
                padding: 12px 15px;
            }
            .el-form {
                padding: 10px;
            }
            .el-form-item {
                margin-bottom: 15px;
            }
            .form-actions {
                flex-direction: column;
            }
            .form-actions .el-button {
                width: 100%;
                margin-right: 0 !important;
            }
        }

        /* 动画效果 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .address-card, .el-card {
            animation: fadeIn 0.5s ease forwards;
        }
        .address-card:nth-child(2n) {
            animation-delay: 0.1s;
        }
        .address-card:nth-child(3n) {
            animation-delay: 0.2s;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <el-page-header
            @back="handleBack"
            content="收货地址管理">
    </el-page-header>

    <!-- 地址列表区域 -->
    <el-card v-if="!isAdding && !isEditing" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);" v-loading="loading">
        <div slot="header" class="card-header">
            <span>已保存的地址</span>
            <el-button class="add-address-btn" @click="startAddAddress" :disabled="loading" style="display: flex; align-items: center; gap: 5px;">
                <i class="fa fa-plus"></i> 新增地址
            </el-button>
        </div>

        <div v-if="addressList.length === 0" class="empty-state">
            <el-empty description="暂无保存的地址">
                <el-button class="add-address-btn" @click="startAddAddress" slot="bottom">
                    <i class="fa fa-plus"></i> 新增第一个地址
                </el-button>
            </el-empty>
        </div>

        <div v-else class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
            <el-card
                    v-for="(address, index) in addressList"
                    :key="address.id"
                    class="address-card"
                    :style="{animationDelay: (index * 0.1) + 's'}"
            >
                <div>
                    <div class="address-header">
                        <div class="address-name">
                            <i class="fa fa-map-marker"></i> {{ address.name }}
                        </div>
                    </div>

                    <p class="address-main">{{ address.address }}</p>

                    <div class="operation-buttons">
                        <el-button
                                size="small"
                                class="edit-btn"
                                @click="startEditAddress(address)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-pencil"></i> 编辑
                        </el-button>
                        <el-button
                                size="small"
                                class="delete-btn"
                                @click="deleteAddress(address.id, index)"
                                :disabled="loading"
                                style="display: flex; align-items: center; gap: 3px;"
                        >
                            <i class="fa fa-trash"></i> 删除
                        </el-button>
                    </div>
                </div>
            </el-card>
        </div>
    </el-card>

    <!-- 新增地址表单 -->
    <el-card v-if="isAdding" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);">
        <div slot="header" class="card-header">
            <span>新增地址</span>
            <el-button type="text" @click="cancelOperation" style="display: flex; align-items: center; gap: 3px;">
                <i class="fa fa-times"></i> 取消
            </el-button>
        </div>

        <el-form
                :model="form"
                ref="form"
                :rules="rules"
                label-width="100px"
                class="mt-4"
        >
            <!-- 地区选择 -->
            <el-form-item
                    label="所在地区"
                    prop="region"
            >
                <el-cascader
                        v-model="form.region"
                        :options="regionOptions"
                        :props="regionProps"
                        clearable
                        placeholder="请选择省/市/区"
                        @change="handleRegionChange"
                        style="width: 100%;"
                ></el-cascader>
            </el-form-item>

            <!-- 地址搜索 -->
            <el-form-item
                    label="详细地址"
                    prop="selectedAddress"
                    v-if="form.cityCode"
            >
                <el-autocomplete
                        v-model="form.addressKeyword"
                        :fetch-suggestions="queryAddress"
                        placeholder="请输入详细地址"
                        @select="handleAddressSelect"
                        value-key="value"
                        clearable
                        style="width: 100%;"
                >
                    <template slot-scope="{ item }">
                        <div style="line-height: 1.5;">
                            <div style="font-weight: 500; color: #333;">{{ item.title }}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 2px;">{{ item.address }}</div>
                        </div>
                    </template>
                </el-autocomplete>

                <!-- 选中的地址信息 -->
                <div v-if="form.selectedAddress" class="selected-address">
                    <p class="title">{{ form.selectedAddress.title }}</p>
                    <p class="detail">{{ form.selectedAddress.address }}</p>
                </div>
            </el-form-item>

            <!-- 推送SPT -->
            <el-form-item
                    label="推送SPT"
                    prop="spt"
            >
                <el-input
                        v-model="form.spt"
                        placeholder="请输入推送SPT内容（选填）"
                        maxlength="100"
                ></el-input>
            </el-form-item>

            <!-- 推送开关 -->
            <el-form-item label="是否推送">
                <el-switch
                        v-model="form.pushSwitch"
                        active-text="是"
                        inactive-text="否"
                        active-color="#36b37e"
                ></el-switch>
            </el-form-item>

            <!-- 按钮区域 -->
            <div class="form-actions">
                <el-button @click="cancelOperation" :disabled="loading">取消</el-button>
                <el-button type="primary" @click="submitForm" :loading="loading" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-check"></i> 确定
                </el-button>
            </div>
        </el-form>
    </el-card>

    <!-- 编辑地址表单 -->
    <el-card v-if="isEditing" class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);">
        <div slot="header" class="card-header">
            <span>编辑地址</span>
            <el-button type="text" @click="cancelOperation" style="display: flex; align-items: center; gap: 3px;">
                <i class="fa fa-times"></i> 取消
            </el-button>
        </div>

        <el-form
                :model="form"
                ref="form"
                label-width="100px"
                class="mt-4"
        >
            <!-- 地址信息（不可编辑） -->
            <el-form-item label="地址名称">
                <el-input v-model="form.name" disabled></el-input>
            </el-form-item>

            <el-form-item label="详细地址">
                <el-input v-model="form.address" disabled type="textarea" :rows="2"></el-input>
            </el-form-item>

            <!-- 可编辑的内容 -->
            <el-form-item
                    label="推送SPT"
                    prop="spt"
            >
                <el-input
                        v-model="form.spt"
                        placeholder="请输入推送SPT内容（选填）"
                        maxlength="100"
                ></el-input>
            </el-form-item>

            <el-form-item label="是否推送">
                <el-switch
                        v-model="form.pushSwitch"
                        active-text="是"
                        inactive-text="否"
                        active-color="#36b37e"
                ></el-switch>
            </el-form-item>

            <!-- 按钮区域 -->
            <div class="form-actions">
                <el-button @click="cancelOperation" :disabled="loading">取消</el-button>
                <el-button type="primary" @click="updateForm" :loading="loading" style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-check"></i> 保存
                </el-button>
            </div>
        </el-form>
    </el-card>
</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                // 地址列表
                addressList: [],

                // 地区数据
                regionOptions: [
                    {
                        "name": "北京市",
                        "code": "110000",
                        "child": [
                            {"name": "东城区", "code": "110101"},
                            {"name": "西城区", "code": "110102", "child": []},
                            {"name": "朝阳区", "code": "110105", "child": []},
                            {"name": "海淀区", "code": "110108", "child": []}
                        ]
                    },
                    {
                        "name": "四川省",
                        "code": "510000",
                        "child": [
                            {
                                "name": "成都市",
                                "code": "510100",
                                "child": [
                                    {"name": "锦江区", "code": "510104", "child": []},
                                    {"name": "青羊区", "code": "510105", "child": []},
                                    {"name": "武侯区", "code": "510107", "child": []}
                                ]
                            },
                            {
                                "name": "绵阳市",
                                "code": "510700",
                                "child": [
                                    {"name": "涪城区", "code": "510703", "child": []},
                                    {"name": "游仙区", "code": "510704", "child": []}
                                ]
                            }
                        ]
                    }
                ],

                // 级联选择器配置
                regionProps: {
                    value: 'code',
                    label: 'name',
                    children: 'child'
                },

                // 表单数据
                form: {
                    id: null,
                    name: '',
                    address: '',
                    region: [], // 存储地区选择的code数组
                    cityCode: null, // 最后一级地区的code (Integer类型)
                    addressKeyword: '', // 地址搜索关键词
                    selectedAddress: null, // 选中的地址信息
                    spt: '', // 推送SPT内容
                    pushSwitch: false // 是否推送
                },

                // 表单验证规则
                rules: {
                    region: [
                        { required: true, message: '请选择所在地区', trigger: 'change' }
                    ],
                    selectedAddress: [
                        { required: true, message: '请选择详细地址', trigger: 'change' }
                    ],
                },

                // 状态控制
                isAdding: false,
                isEditing: false,
                loading: false
            };
        },
        mounted() {
            this.loadAddressList();
        },
        methods: {
            // 加载地址列表
            async loadAddressList() {
                this.loading = true;
                try {
                    const response = await axios.get('/api/location');
                    if (response.data.success) {
                        this.addressList = response.data.data || [];
                    } else {
                        this.$message.error(response.data.msg || '获取地址列表失败');
                    }
                } catch (error) {
                    console.error('获取地址列表失败:', error);
                    this.$message.error('获取地址列表失败，请检查网络连接');
                } finally {
                    this.loading = false;
                }
            },
            // 返回按钮处理
            handleBack() {
                this.$message.info('返回上一页');
            },

            // 开始新增地址
            startAddAddress() {
                this.isAdding = true;
                this.isEditing = false;
                this.resetForm();
            },

            // 开始编辑地址
            startEditAddress(address) {
                this.isEditing = true;
                this.isAdding = false;

                // 填充表单数据（仅可编辑spt和pushSwitch）
                this.form = {
                    id: address.id,
                    name: address.name,
                    address: address.address,
                    spt: address.spt || '',
                    pushSwitch: address.pushSwitch,
                    region: [],
                    cityCode: address.cityCode,
                    addressKeyword: '',
                    selectedAddress: null
                };
            },
        // 查询地址（调用真实接口）
        async queryAddress(queryString, callback) {
          if (!this.form.cityCode || !queryString.trim()) {
            callback([]);
            return;
          }
          
          try {
            // 调用真实的地址搜索接口
            const response = await axios.get('/api/location/searchAddress', {
              params: {
                keyword: queryString.trim(),
                cityCode: this.form.cityCode
              }
            });
            
            if (response.data.success) {
              // 转换数据格式以适配前端显示（为el-autocomplete组件增加value字段）
              const addresses = (response.data.data || []).map(item => ({
                value: item.title, // el-autocomplete组件需要的value字段
                title: item.title,
                address: item.address,
                latitude: item.latitude,
                longitude: item.longitude,
                cityCode: item.cityCode,
                province: item.province,
                city: item.city,
                district: item.district
              }));
              callback(addresses);
            } else {
              console.error('地址搜索失败:', response.data.msg);
              callback([]);
            }
          } catch (error) {
            console.error('地址搜索请求失败:', error);
            callback([]);
          }
        },
            // 取消操作
            cancelOperation() {
                this.isAdding = false;
                this.isEditing = false;
                this.resetForm();
            },

            // 重置表单
            resetForm() {
                this.form = {
                    id: null,
                    name: '',
                    address: '',
                    region: [],
                    cityCode: null,
                    addressKeyword: '',
                    selectedAddress: null,
                    spt: '',
                    pushSwitch: false
                };

                if (this.$refs.form) {
                    this.$refs.form.resetFields();
                }
            },

            // 处理地区选择变化
            handleRegionChange(values) {
                if (values && values.length > 0) {
                    this.form.cityCode = parseInt(values[values.length - 1]);
                } else {
                    this.form.cityCode = null;
                    this.form.selectedAddress = null;
                    this.form.addressKeyword = '';
                }
            },

            // 处理地址选择
            handleAddressSelect(item) {
                this.form.selectedAddress = item;
            },

            // 提交新增表单
            async submitForm() {
                this.$refs.form.validate(async (valid) => {
                    if (valid) {
                        // 准备提交的数据
                        const submitData = {
                            name: this.form.selectedAddress.title,
                            address: this.form.selectedAddress.address,
                            cityCode: this.form.cityCode,
                            latitude: this.form.selectedAddress.latitude,
                            longitude: this.form.selectedAddress.longitude,
                            spt: this.form.spt || null,
                            pushSwitch: this.form.pushSwitch
                        };

                        this.loading = true;
                        try {
                            const response = await axios.post('/api/location', submitData);
                            if (response.data.success) {
                                this.$message.success('地址新增成功');
                                // 重新加载地址列表
                                await this.loadAddressList();
                                // 重置状态
                                this.isAdding = false;
                                this.resetForm();
                            } else {
                                this.$message.error(response.data.msg || '地址新增失败');
                            }
                        } catch (error) {
                            console.error('新增地址失败:', error);
                            this.$message.error('新增地址失败，请检查网络连接');
                        } finally {
                            this.loading = false;
                        }
                    }
                });
            },

            // 提交更新表单
            async updateForm() {
                // 准备更新的数据（仅包含可编辑的字段）
                const updateData = {
                    spt: this.form.spt || null,
                    pushSwitch: this.form.pushSwitch
                };

                this.loading = true;
                try {
                    const response = await axios.put(`/api/location/${this.form.id}`, updateData);
                    if (response.data.success) {
                        this.$message.success('地址更新成功');
                        // 重新加载地址列表
                        await this.loadAddressList();
                        // 重置状态
                        this.isEditing = false;
                        this.resetForm();
                    } else {
                        this.$message.error(response.data.msg || '地址更新失败');
                    }
                } catch (error) {
                    console.error('更新地址失败:', error);
                    this.$message.error('更新地址失败，请检查网络连接');
                } finally {
                    this.loading = false;
                }
            },

            // 删除地址
            deleteAddress(id, index) {
                this.$confirm('确定要删除这个地址吗？', '提示', {
                    confirmButtonText: '确定',
                    cancelButtonText: '取消',
                    type: 'warning'
                }).then(async () => {
                    this.loading = true;
                    try {
                        const response = await axios.delete(`/api/location/${id}`);
                        if (response.data.success) {
                            this.$message.success('地址删除成功');
                            // 重新加载地址列表
                            await this.loadAddressList();
                        } else {
                            this.$message.error(response.data.msg || '地址删除失败');
                        }
                    } catch (error) {
                        console.error('删除地址失败:', error);
                        this.$message.error('删除地址失败，请检查网络连接');
                    } finally {
                        this.loading = false;
                    }
                }).catch(() => {
                    this.$message.info('已取消删除');
                });
            }
        }
    });
</script>
</body>
</html>

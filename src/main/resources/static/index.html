<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Â∞èËöïÈó®Â∫óÁÆ°ÁêÜÂπ≥Âè∞</title>
    <!-- Element UI CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <!-- Element UI JS -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- Axios for HTTP requests -->
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .header-title {
            text-align: center;
            color: #2c3e50;
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .search-section {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            justify-content: center;
        }
        
        .search-input {
            min-width: 300px;
            flex: 1;
            max-width: 400px;
        }
        
        .sort-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .store-card {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid #f0f0f0;
        }
        
        .store-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }
        
        .store-item {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .store-image {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .store-image img {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            object-fit: cover;
        }
        
        .store-info {
            flex: 1;
            min-width: 0;
        }
        
        .store-name {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .new-badge {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: normal;
        }
        
        .platform-tag {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-right: 8px;
        }
        
        .platform-meituan {
            background: #ffd93d;
            color: #333;
        }
        
        .platform-eleme {
            background: #0078ff;
            color: white;
        }
        
        .platform-jd {
            background: #e93323;
            color: white;
        }
        
        .store-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            margin-top: 12px;
            font-size: 14px;
            color: #666;
        }
        
        .detail-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .detail-icon {
            font-size: 16px;
            width: 20px;
        }
        
        .highlight {
            color: #e74c3c;
            font-weight: 600;
        }
        
        .success {
            color: #27ae60;
            font-weight: 600;
        }
        
        .store-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex-shrink: 0;
        }
        
        .action-button {
            min-width: 80px;
        }
        
        .loading-container {
            text-align: center;
            padding: 40px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-icon {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }
        
        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .search-section {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-input {
                min-width: auto;
                max-width: none;
            }
            
            .sort-buttons {
                justify-content: center;
            }
            
            .content {
                padding: 20px;
            }
            
            .store-item {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .store-image {
                width: 60px;
                height: 60px;
                align-self: center;
            }
            
            .store-details {
                grid-template-columns: 1fr;
            }
            
            .store-actions {
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .action-button {
                flex: 1;
                min-width: 70px;
            }
        }
        
        @media (max-width: 480px) {
            .store-card {
                padding: 15px;
            }
            
            .store-name {
                font-size: 16px;
            }
            
            .store-details {
                font-size: 13px;
            }
        }
        
        /* Âä®ÁîªÊïàÊûú */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .bounce-in {
            animation: bounceIn 0.6s ease-out;
        }
        
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <!-- Â§¥ÈÉ®ÊêúÁ¥¢Âå∫Âüü -->
            <div class="header fade-in">
                <h1 class="header-title">üêõ Â∞èËöïÈó®Â∫óÁÆ°ÁêÜÂπ≥Âè∞</h1>
                <div class="search-section">
                    <el-input
                        v-model="searchForm.name"
                        placeholder="ËØ∑ËæìÂÖ•Èó®Â∫óÂêçÁß∞"
                        class="search-input"
                        clearable
                        @keyup.enter.native="handleSearch"
                    >
                        <el-button slot="append" icon="el-icon-search" @click="handleSearch"></el-button>
                    </el-input>
                    
                    <div class="sort-buttons">
                        <el-button-group>
                            <el-button
                                :type="searchForm.orderType === 1 ? 'primary' : 'default'"
                                @click="handleSort(1)"
                            >
                                ÈªòËÆ§ÊéíÂ∫è
                            </el-button>
                            <el-button
                                :type="searchForm.orderType === 2 ? 'primary' : 'default'"
                                @click="handleSort(2)"
                            >
                                ËøîÁé∞ÈáëÈ¢ù
                            </el-button>
                            <el-button
                                :type="searchForm.orderType === 3 ? 'primary' : 'default'"
                                @click="handleSort(3)"
                            >
                                ËøîÁé∞ÊØî‰æã
                            </el-button>
                        </el-button-group>
                        
                        <el-button type="info" icon="el-icon-location" @click="goToAddressPage">
                            Âú∞ÂùÄÈÄâÊã©
                        </el-button>
                        
                        <el-button type="success" @click="handleSearch" :loading="loading">
                            <i class="el-icon-refresh-right"></i> ÊêúÁ¥¢
                        </el-button>
                    </div>
                </div>
            </div>
            
            <!-- ÂÜÖÂÆπÂå∫Âüü -->
            <div class="content">
                <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
                <div v-if="loading" class="loading-container">
                    <el-loading-text>Ê≠£Âú®Âä†ËΩΩÈó®Â∫ó‰ø°ÊÅØ...</el-loading-text>
                </div>
                
                <!-- Á©∫Áä∂ÊÄÅ -->
                <div v-else-if="storeList.length === 0" class="empty-state">
                    <div class="empty-icon">üè™</div>
                    <h3>ÊöÇÊó†Èó®Â∫ó‰ø°ÊÅØ</h3>
                    <p>ËØ∑Â∞ùËØïË∞ÉÊï¥ÊêúÁ¥¢Êù°‰ª∂ÊàñÁ®çÂêéÂÜçËØï</p>
                </div>
                
                <!-- Èó®Â∫óÂàóË°® -->
                <div v-else>
                    <div 
                        v-for="(store, index) in storeList" 
                        :key="store.storeId"
                        class="store-card bounce-in"
                        :style="{ animationDelay: (index * 0.1) + 's' }"
                    >
                        <div class="store-item">
                            <!-- Èó®Â∫óÂõæÁâá -->
                            <div class="store-image">
                                <img v-if="store.icon" :src="store.icon" :alt="store.name" />
                                <span v-else>{{ store.name.charAt(0) }}</span>
                            </div>
                            
                            <!-- Èó®Â∫ó‰ø°ÊÅØ -->
                            <div class="store-info">
                                <div class="store-name">
                                    {{ store.name }}
                                    <span v-if="store.ifNew" class="new-badge">Êñ∞Â∫ó</span>
                                    <span :class="getPlatformClass(store.type)">{{ getPlatformName(store.type) }}</span>
                                </div>
                                
                                <div class="store-details">
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-time"></i>
                                        <span>Ëê•‰∏öÊó∂Èó¥Ôºö{{ store.openHours }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-money"></i>
                                        <span>Êª°{{ store.price }}Ëøî<span class="highlight">{{ store.rebatePrice }}</span></span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-clock"></i>
                                        <span>Ê¥ªÂä®Êó∂Èó¥Ôºö{{ store.startTime }} - {{ store.endTime }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-goods"></i>
                                        <span>Ââ©‰ΩôÊï∞ÈáèÔºö<span :class="store.leftNumber > 0 ? 'success' : 'highlight'">{{ store.leftNumber }}</span></span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-star-on"></i>
                                        <span>Â•ΩËØÑÊù°‰ª∂Ôºö{{ getRebateConditionText(store.rebateCondition) }}</span>
                                    </div>
                                    <div class="detail-item">
                                        <i class="detail-icon el-icon-location-outline"></i>
                                        <span>Ë∑ùÁ¶ªÔºö{{ formatDistance(store.distance) }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Êìç‰ΩúÊåâÈíÆ -->
                            <div class="store-actions">
                                <el-button
                                    v-if="canApply(store)"
                                    type="primary"
                                    size="small"
                                    class="action-button"
                                    @click="handleApply(store)"
                                    :loading="actionLoading[store.promotionId + '_apply']"
                                >
                                    Êä•Âêç
                                </el-button>
                                <el-button
                                    v-if="store.leftNumber > 0"
                                    type="success"
                                    size="small"
                                    class="action-button"
                                    @click="handleBook(store)"
                                    :loading="actionLoading[store.promotionId + '_book']"
                                >
                                    È¢ÑÁ∫¶
                                </el-button>
                                <el-button
                                    type="warning"
                                    size="small"
                                    class="action-button"
                                    @click="handleIgnore(store)"
                                    :loading="actionLoading[store.storeId + '_ignore']"
                                >
                                    ÂøΩÁï•
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    loading: false,
                    actionLoading: {},
                    searchForm: {
                        name: '',
                        orderType: 1,
                        cityCode: null,
                        latitude: '',
                        longitude: ''
                    },
                    storeList: []
                }
            },
            mounted() {
                this.handleSearch();
                this.getCurrentLocation();
            },
            methods: {
                // ÊêúÁ¥¢Èó®Â∫ó
                async handleSearch() {
                    this.loading = true;
                    try {
                        const response = await axios.post('/api/xiaochan/query', this.searchForm);
                        if (response.data.success) {
                            this.storeList = response.data.data || [];
                            this.$message.success('Êü•ËØ¢ÊàêÂäü');
                        } else {
                            this.$message.error(response.data.msg || 'Êü•ËØ¢Â§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('Êü•ËØ¢Â§±Ë¥•:', error);
                        this.$message.error('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                        // Ê®°ÊãüÊï∞ÊçÆÁî®‰∫éÂ±ïÁ§∫
                        this.loadMockData();
                    } finally {
                        this.loading = false;
                    }
                },
                
                // ÊéíÂ∫èÂ§ÑÁêÜ
                handleSort(orderType) {
                    this.searchForm.orderType = orderType;
                    this.handleSearch();
                },
                
                // Êä•Âêç
                async handleApply(store) {
                    const loadingKey = store.promotionId + '_apply';
                    this.$set(this.actionLoading, loadingKey, true);
                    
                    try {
                        const response = await axios.post(`/api/xiaochan/apply/${store.promotionId}`);
                        if (response.data.success) {
                            this.$message.success('Êä•ÂêçÊàêÂäüÔºÅ');
                            this.handleSearch(); // Âà∑Êñ∞ÂàóË°®
                        } else {
                            this.$message.error(response.data.msg || 'Êä•ÂêçÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('Êä•ÂêçÂ§±Ë¥•:', error);
                        this.$message.error('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                    } finally {
                        this.$set(this.actionLoading, loadingKey, false);
                    }
                },
                
                // È¢ÑÁ∫¶
                async handleBook(store) {
                    const loadingKey = store.promotionId + '_book';
                    this.$set(this.actionLoading, loadingKey, true);
                    
                    try {
                        const bookData = {
                            promotionId: store.promotionId,
                            startTime: store.startTime
                        };
                        const response = await axios.post('/api/xiaochan/book', bookData);
                        if (response.data.success) {
                            this.$message.success('È¢ÑÁ∫¶ÊàêÂäüÔºÅ');
                            this.handleSearch(); // Âà∑Êñ∞ÂàóË°®
                        } else {
                            this.$message.error(response.data.msg || 'È¢ÑÁ∫¶Â§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('È¢ÑÁ∫¶Â§±Ë¥•:', error);
                        this.$message.error('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                    } finally {
                        this.$set(this.actionLoading, loadingKey, false);
                    }
                },
                
                // ÂøΩÁï•
                async handleIgnore(store) {
                    const loadingKey = store.storeId + '_ignore';
                    this.$set(this.actionLoading, loadingKey, true);
                    
                    try {
                        const ignoreData = {
                            storeId: store.storeId.toString(),
                            storeName: store.name,
                            type: store.type,
                            price: store.price,
                            rebatePrice: store.rebatePrice,
                            rebateCondition: store.rebateCondition,
                            icon: store.icon
                        };
                        const response = await axios.post('/api/xiaochan/ignore', ignoreData);
                        if (response.data.success) {
                            this.$message.success('Â∑≤ÂøΩÁï•ËØ•Èó®Â∫ó');
                            this.handleSearch(); // Âà∑Êñ∞ÂàóË°®
                        } else {
                            this.$message.error(response.data.msg || 'Êìç‰ΩúÂ§±Ë¥•');
                        }
                    } catch (error) {
                        console.error('ÂøΩÁï•Â§±Ë¥•:', error);
                        this.$message.error('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                    } finally {
                        this.$set(this.actionLoading, loadingKey, false);
                    }
                },
                
                // Ëé∑ÂèñÂπ≥Âè∞ÂêçÁß∞
                getPlatformName(type) {
                    const platforms = {
                        1: 'ÁæéÂõ¢',
                        2: 'È•ø‰∫Ü‰πà',
                        3: '‰∫¨‰∏ú'
                    };
                    return platforms[type] || 'Êú™Áü•';
                },
                
                // Ëé∑ÂèñÂπ≥Âè∞Ê†∑ÂºèÁ±ª
                getPlatformClass(type) {
                    const classes = {
                        1: 'platform-tag platform-meituan',
                        2: 'platform-tag platform-eleme',
                        3: 'platform-tag platform-jd'
                    };
                    return classes[type] || 'platform-tag';
                },
                
                // Ëé∑ÂèñÂ•ΩËØÑÊù°‰ª∂ÊñáÊú¨
                getRebateConditionText(condition) {
                    const conditions = {
                        99: 'Êó†ÈúÄËØÑ‰ª∑',
                        2: 'ÂõæÊñáËØÑ‰ª∑'
                    };
                    return conditions[condition] || 'ÂÖ∂‰ªñ';
                },
                
                // Ê†ºÂºèÂåñË∑ùÁ¶ª
                formatDistance(distance) {
                    if (distance < 1000) {
                        return distance + 'm';
                    } else {
                        return (distance / 1000).toFixed(1) + 'km';
                    }
                },
                
                // Âà§Êñ≠ÊòØÂê¶ÂèØ‰ª•Êä•Âêç
                canApply(store) {
                    if (store.leftNumber <= 0) return false;
                    
                    // Ê£ÄÊü•ÂΩìÂâçÊó∂Èó¥ÊòØÂê¶Âú®Ê¥ªÂä®Êó∂Èó¥ÂÜÖ
                    const now = new Date();
                    const currentTime = now.getHours().toString().padStart(2, '0') + ':' + 
                                      now.getMinutes().toString().padStart(2, '0');
                    
                    return currentTime >= store.startTime && currentTime <= store.endTime;
                },
                
                // Ëé∑ÂèñÂΩìÂâç‰ΩçÁΩÆ
                getCurrentLocation() {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            (position) => {
                                this.searchForm.latitude = position.coords.latitude.toString();
                                this.searchForm.longitude = position.coords.longitude.toString();
                            },
                            (error) => {
                                console.log('Ëé∑Âèñ‰ΩçÁΩÆÂ§±Ë¥•:', error);
                            }
                        );
                    }
                },
                
                // Ê®°ÊãüÊï∞ÊçÆÔºàÁî®‰∫éÊºîÁ§∫Ôºâ
                loadMockData() {
                    this.storeList = [
                        {
                            name: "È∫¶ÂΩìÂä≥(ÁéãÂ∫ú‰∫ïÂ∫ó)",
                            storeId: 1001,
                            ifNew: true,
                            openHours: "10:00-22:00",
                            promotionId: 2001,
                            type: 1,
                            startTime: "08:00",
                            endTime: "21:00",
                            leftNumber: 15,
                            distance: 500,
                            price: 30.00,
                            rebatePrice: 5.00,
                            rebateCondition: 99,
                            icon: "https://via.placeholder.com/80/ff6b6b/ffffff?text=M"
                        },
                        {
                            name: "ËÇØÂæ∑Âü∫(‰∏âÈáåÂ±ØÂ∫ó)",
                            storeId: 1002,
                            ifNew: false,
                            openHours: "09:00-23:00",
                            promotionId: 2002,
                            type: 2,
                            startTime: "09:00",
                            endTime: "20:00",
                            leftNumber: 0,
                            distance: 1200,
                            price: 25.00,
                            rebatePrice: 8.00,
                            rebateCondition: 2,
                            icon: "https://via.placeholder.com/80/0078ff/ffffff?text=K"
                        },
                        {
                            name: "ÊòüÂ∑¥ÂÖã(CBDÂ∫ó)",
                            storeId: 1003,
                            ifNew: false,
                            openHours: "07:00-22:00",
                            promotionId: 2003,
                            type: 3,
                            startTime: "10:00",
                            endTime: "18:00",
                            leftNumber: 8,
                            distance: 800,
                            price: 50.00,
                            rebatePrice: 12.00,
                            rebateCondition: 99,
                            icon: "https://via.placeholder.com/80/e93323/ffffff?text=S"
                        }
                    ];
                },
                
                // Ë∑≥ËΩ¨Âà∞Âú∞ÂùÄÈÄâÊã©È°µÈù¢
                goToAddressPage() {
                    window.open('/address.html', '_blank');
                }
            }
        });
    </script>
</body>
</html>